<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Разметка текста</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/base.css' %}" />
    <link rel="stylesheet" href="{% static 'css/text_markup.css' %}" />
</head>
<body>

    <div class="menu">
        <!-- Форма для выбора разметки частей речи -->
        <form method="get" action="">
            <label for="markup">Вид:</label>
            <select name="markup" id="markup">
                <option value="tagtext" {% if selected_pos_markup == 'tagtext' %}selected{% endif %}>Части речи (Основная)</option>
                <option value="tagtextrussian" {% if selected_pos_markup == 'tagtextrussian' %}selected{% endif %}>Части речи (На русском)</option>
                <option value="tagtextabbrev" {% if selected_pos_markup == 'tagtextabbrev' %}selected{% endif %}>Аббревиатуры частей речи</option>
                <option value="error" {% if selected_error_markup == 'error' %}selected{% endif %}>Ошибки (Основная)</option>
                <option value="error_russian" {% if selected_error_markup == 'error_russian' %}selected{% endif %}>Ошибки (На русском)</option>
                <option value="error_abbrev" {% if selected_error_markup == 'error_abbrev' %}selected{% endif %}>Аббревиатуры ошибок</option>
                <option value="plain" {% if selected_pos_markup == 'plain' %}selected{% endif %}>Без разметки</option>
            </select>
        </form>
    </div>

    <div class="text-header">
        <h1 class="text-title">{{ text.header }}</h1>
    </div>

    <!-- Всплывающее окно для ошибок -->
    <div class="error-popup" id="error-popup">
        <span class="close-btn" id="close-popup">X</span>
        <h3>
            <span id="error-tag"></span>
            <span id="error-tag-abbrev"></span>
        </h3>
        <p><strong>Степень грубости:</strong> <span id="error-level"></span></p>
        <p><strong>Исправление:</strong> <span id="error-correct"></span></p>
        <p><strong>Комментарий:</strong> <span id="error-comment"></span></p>
    </div>

    <div class="watch-text">
        {% for sentence in sentence_data %}
            <div class="sentence">
                <p class="sentence-number">{{ forloop.counter }}:</p>
                <div class="tokens-container">
                    {% for token in sentence.tokens %}
                        <span class="token" 
                            {% if token.error_tag %}
                                data-error-tag="{{ token.error_tag }}" 
                                data-error-tag-abbrev="{{ token.error_tag_abbrev }}" 
                                data-error-level="{{ token.error_level }}" 
                                data-error-correct="{{ token.error_correct }}" 
                                data-error-comment="{{ token.error_comment }}" 
                                data-error-color="{{ token.error_color }}"
                            {% endif %}>
                            
                            {% if token.error_tag %}
                                <span class="error-tag" style="background-color: {{ token.error_color }};">
                                    {{ token.error_tag }}
                                </span>
                            {% else %}
                                <span class="no-abbr">&nbsp;</span> 
                            {% endif %}
                            
                            {% if token.idpostag %}
                            <span class="abbr" style="background-color: {{ token.idpostag.tagcolor }};"
                                tagtext="{{ token.idpostag.tagtext }}"
                                tagtextrussian="{{ token.idpostag.tagtextrussian }}"
                                tagtextabbrev="{{ token.idpostag.tagtextabbrev }}"
                                >
                            </span>
                            {% else %}
                                <span class="no-abbr">&nbsp;</span> 
                            {% endif %}
                            
                            <span class="word">{{ token.token }}</span>

                        </span>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>

    <script>

        document.querySelectorAll('.token').forEach(token => {
            token.addEventListener('click', function() {
                var errorTag = this.getAttribute('data-error-tag');
                var errorTagAbbrev = this.getAttribute('data-error-tag-abbrev');
                var errorLevel = this.getAttribute('data-error-level');
                var errorCorrect = this.getAttribute('data-error-correct');
                var errorComment = this.getAttribute('data-error-comment');
                var errorColor = this.getAttribute('data-error-color');

                if (errorTag || errorTagAbbrev) {
                    document.getElementById('error-popup').style.display = 'block';
                    document.getElementById('error-tag').textContent = errorTag || errorTagAbbrev;
                    document.getElementById('error-tag-abbrev').textContent = errorTagAbbrev || '';
                    document.getElementById('error-level').textContent = errorLevel || 'Не указано';
                    document.getElementById('error-correct').textContent = errorCorrect || 'Не указано';
                    document.getElementById('error-comment').textContent = errorComment || 'Не указано';
                    document.getElementById('error-popup').style.backgroundColor = errorColor || '#fff';
                }
            });
        });

        document.getElementById('close-popup').addEventListener('click', function() {
            document.getElementById('error-popup').style.display = 'none';
        });

        document.addEventListener('DOMContentLoaded', function() {
        const markupSelect = document.getElementById('markup');

        // Функция для отображения разметки
        function displayMarkup() {
            const abbrElements = document.querySelectorAll('.abbr');
            const noAbbrElements = document.querySelectorAll('.no-abbr');

            abbrElements.forEach(el => {
                // Получаем значение атрибута tagtext
                const tag = el.getAttribute(markupSelect);

                // Если выбрано значение 'tagtext', отображаем текст
                if (markupSelect.value === tag && tagtext) {
                    el.textContent = tagtext; // Устанавливаем текст из атрибута
                    el.style.display = 'inline'; // Убедимся, что элемент виден
                } else {
                    // В противном случае скрываем элемент
                    el.style.display = 'none';
                    el.textContent = ""; // Очищаем текст, если разметка не tagtext
                }
            });
        }

        // Вызвать функцию при загрузке страницы
        displayMarkup();

        // Добавить слушатель для изменения значения в селекте
        markupSelect.addEventListener('change', displayMarkup);
    });

        // document.addEventListener('DOMContentLoaded', function() {
        //     const markupSelect = document.getElementById('markup');

        //     function toggleAbbrVisibility() {
        //         const abbrElements = document.querySelectorAll('.abbr');
        //         if (markupSelect.value === 'plain') {
        //             abbrElements.forEach(el => el.style.display = 'none');
        //         } else {
        //             abbrElements.forEach(el => el.style.display = 'flex');
        //         }
        //     }

        //     // Вызвать функцию при загрузке страницы
        //     toggleAbbrVisibility();

        //     // Добавить слушатель для изменения значения в селекте
        //     markupSelect.addEventListener('change', toggleAbbrVisibility);
        // });
    </script>

</body>
</html>
